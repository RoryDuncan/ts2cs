# ts2cs

A TypeScript to C# transpiler designed for **Godot 4.x** game development. Write your game logic in TypeScript with full intellisense support, then transpile to Godot-compatible C# scripts.

## Features

- **Godot Integration** - Automatic detection of Godot base classes (`Node`, `Node2D`, `CharacterBody2D`, etc.) with proper `using Godot;` generation
- **Type Transpilation** - Comprehensive TypeScript to C# type mappings with configurable options
- **Class Support** - Full class transpilation including properties, methods, constructors, and inheritance
- **Discriminated Unions** - TypeScript discriminated unions become abstract base classes with subclasses
- **Enums & Interfaces** - Native transpilation of TypeScript enums and interfaces
- **Async/Await** - `Promise<T>` maps to `Task<T>`, async methods transpile correctly
- **Accessors** - TypeScript getters/setters become C# properties
- **Constructor Parameter Properties** - `constructor(public name: string)` generates fields and assignments
- **Statement Transpilation** - Control flow, operators, and expressions

## Installation

```bash
npm install ts2cs-transpiler
```

### Requirements

- Node.js >= 18.0.0
- TypeScript 5.x

## Usage

### Programmatic API

```typescript
import { Transpiler } from 'ts2cs-transpiler';

const transpiler = new Transpiler({
  inputDir: './src',
  outputDir: './csharp',
  namespace: 'MyGame',
});

const result = await transpiler.transpile();
```

### Direct Source Transpilation

```typescript
import { transpileSource } from 'ts2cs-transpiler/transpiler';

const tsCode = `
class Player extends Node2D {
  health: number = 100;
  
  takeDamage(amount: number): void {
    this.health -= amount;
  }
}
`;

const csCode = transpileSource(tsCode);
```

### Example Output

**TypeScript Input:**

```typescript
class Player extends Node2D {
  health: number = 100;
  private name: string;

  constructor(name: string) {
    this.name = name;
  }

  takeDamage(amount: number): void {
    this.health -= amount;
  }

  get isAlive(): boolean {
    return this.health > 0;
  }
}
```

**C# Output:**

```csharp
// <auto-generated>
//     This file was generated by ts2cs. Do not edit manually.
// </auto-generated>

using Godot;

public partial class Player : Node2D
{
    public float health = 100;
    private string name;

    public Player(string name)
    {
        this.name = name;
    }

    public void TakeDamage(float amount)
    {
        this.health -= amount;
    }

    public bool isAlive
    {
        get => this.health > 0;
    }
}
```

## Configuration

Create a configuration object with the following options:

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `inputDir` | `string` | *required* | Input directory containing TypeScript source files |
| `outputDir` | `string` | *required* | Output directory for generated C# files |
| `namespace` | `string` | *derived* | Base C# namespace (defaults to PascalCase of inputDir) |
| `numberType` | `'float' \| 'double'` | `'float'` | C# type for TypeScript `number` |
| `arrayTransform` | `'array' \| 'list' \| 'godot-array'` | `'list'` | How to transform TypeScript arrays |
| `typedArrayTransform` | `'array' \| 'span'` | `'array'` | How to transform TypedArrays |
| `discriminatedUnionStrategy` | `'abstract-subclass' \| 'tagged-struct'` | `'abstract-subclass'` | Strategy for discriminated unions |
| `filePerModule` | `boolean` | `true` | Emit one C# file per TypeScript module |
| `watch` | `boolean` | `false` | Enable watch mode |

### Example Configuration

```typescript
import { Transpiler } from 'ts2cs-transpiler';

const transpiler = new Transpiler({
  inputDir: './src/scripts',
  outputDir: './godot/scripts',
  namespace: 'MyGame.Scripts',
  numberType: 'double',  // Use double instead of float
  arrayTransform: 'godot-array',  // Use Godot.Collections.Array<T>
});
```

## Type Mappings

### Primitive Types

| TypeScript | C# |
|------------|-----|
| `string` | `string` |
| `number` | `float` (configurable to `double`) |
| `boolean` | `bool` |
| `any` | `object` |
| `unknown` | `object` |
| `void` | `void` |
| `null` | `null` |
| `undefined` | `null` |

### Array Types

| TypeScript | C# (default: list) | C# (array) | C# (godot-array) |
|------------|-------------------|------------|------------------|
| `T[]` | `List<T>` | `T[]` | `Godot.Collections.Array<T>` |
| `Array<T>` | `List<T>` | `T[]` | `Godot.Collections.Array<T>` |

### TypedArrays

| TypeScript | C# |
|------------|-----|
| `Int8Array` | `sbyte[]` |
| `Uint8Array` | `byte[]` |
| `Int16Array` | `short[]` |
| `Uint16Array` | `ushort[]` |
| `Int32Array` | `int[]` |
| `Uint32Array` | `uint[]` |
| `Float32Array` | `float[]` |
| `Float64Array` | `double[]` |

### Nullable Types

| TypeScript | C# |
|------------|-----|
| `T \| null` | `T?` |
| `T \| undefined` | `T?` |

### Collection Types

| TypeScript | C# |
|------------|-----|
| `Map<K, V>` | `Dictionary<K, V>` |
| `Set<T>` | `HashSet<T>` |
| `Record<K, V>` | `Dictionary<K, V>` |

### Async Types

| TypeScript | C# |
|------------|-----|
| `Promise<T>` | `Task<T>` |
| `Promise<void>` | `Task` |
| `async function` | `async Task` method |

## Discriminated Unions

TypeScript discriminated unions are transpiled to an abstract base class with concrete subclasses:

**TypeScript:**

```typescript
type Shape =
  | { kind: 'circle'; radius: number }
  | { kind: 'square'; size: number };
```

**C#:**

```csharp
public abstract partial class Shape
{
    public abstract string Kind { get; }
}

public partial class Circle : Shape
{
    public override string Kind => "circle";
    public float radius;
}

public partial class Square : Shape
{
    public override string Kind => "square";
    public float size;
}
```

## Godot Base Classes

The transpiler automatically detects Godot base classes and adds `using Godot;` when needed. Recognized classes include:

- `Node`, `Node2D`, `Node3D`
- `Sprite2D`, `Sprite3D`
- `CharacterBody2D`, `CharacterBody3D`
- `RigidBody2D`, `RigidBody3D`
- `Area2D`, `Area3D`
- `Control`, `Label`, `Button`
- `Resource`, `RefCounted`
- And many more...

All generated classes use the `partial` modifier as required by Godot 4.x C#.

## Development

### Building

```bash
cd packages/transpiler
npm install
npm run build
```

### Testing

```bash
npm test          # Run tests in watch mode
npm run test:run  # Run tests once
```

### Linting

```bash
npm run lint
npm run lint:fix
```

### Project Structure

```
packages/transpiler/
├── src/
│   ├── index.ts              # Main API exports
│   ├── transpiler.ts         # Core transpilation logic
│   ├── config/
│   │   └── schema.ts         # Configuration schema (valibot)
│   ├── godot/
│   │   ├── classes.ts        # Godot class detection
│   │   └── index.ts          # Barrel exports
│   ├── transformers/
│   │   ├── types.ts          # Type mappings
│   │   ├── properties.ts     # Property transpilation
│   │   ├── methods.ts        # Method transpilation
│   │   ├── accessors.ts      # Getter/setter transpilation
│   │   ├── enums.ts          # Enum transpilation
│   │   ├── interfaces.ts     # Interface transpilation
│   │   ├── statements.ts     # Statement transpilation
│   │   ├── expressions.ts    # Expression transpilation
│   │   ├── unions.ts         # Union type analysis
│   │   └── discriminated-unions.ts
│   └── utils/
│       └── naming.ts         # Naming conventions (PascalCase, etc.)
└── tests/
    ├── helpers.ts
    ├── transformers/
    ├── transpiler/
    └── ts-features/
```

## Roadmap

### Completed

- Project setup and architecture
- TDD transpiler core with class transpilation
- Basic type mappings with configurable number type
- Class properties and access modifiers
- Methods, constructors, and parameter properties
- Getters and setters
- Imports and namespace handling
- Discriminated unions (abstract class pattern)
- Enum transpilation
- Interface transpilation
- Async/await support (Promise -> Task)
- Collection types (Dictionary, Map, Set)
- Statement and expression transpilation
- C# keyword escaping (@base, @class, etc.)

### In Progress

- Godot module code organization refactoring

### Planned

- **Configurable Array Transformations**
  - `arrayTransform` option: array/list/godot-array
  - TypedArray support (Int32Array, Float64Array, etc.)
  - Proper using statements for System.Collections.Generic
- **CLI Tool** - Command-line interface for transpilation
- **Watch Mode** - File watching for incremental compilation
- **Generics Support** - Generic type parameter transpilation
- **Source Maps** - Map generated C# back to TypeScript source

## License

MIT

